<html>

<head>

<script type="text/javascript">


function print_console(text){
	document.getElementById("status").value = text;
}

function aread()
{    
    print_console("Запрос инициирован...");
    
    var request = new XMLHttpRequest();
    request.open('GET',document.location.origin+'/ahandler.htm',true);
    request.addEventListener('readystatechange', function() {     
        
        if(request.readyState == 4)
        {
        	if(request.status==200)
        	{
	            print_console("Обмен завершен успешно.");
				
				var pars = request.responseText.split(";");
				
				try
				{
					for (var i = 0; i < 12; i++) {
						var num = i+1
						document.getElementById("pv"+num.toString()).value = "T= "+pars[i]+" С;    Zd= "+pars[i+12];
						if (pars[24+i]=="True")
						{
							document.getElementById("pv"+num.toString()).className = "button_is_on";
						}
						else
						{
							document.getElementById("pv"+num.toString()).className = "button_is_off";
						}
					}
					
					var index = parseInt(document.getElementById("unitn").value, 10);
					document.getElementById("write_sp").value = pars[11+index]; //request.responseText;
					if (pars[23+index]=="True")
					{
						document.getElementById("CmdOn").className = "button_is_on";
						document.getElementById("CmdOff").className = "button_is_on";
					}
					else
					{
						document.getElementById("CmdOn").className = "button_is_off";
						document.getElementById("CmdOff").className = "button_is_off";
					}
					
				}catch(exception)
				{
					document.getElementById("write_sp").value = "exception";
				};
        	}
        	else
        	{
	            print_console("Ошибка:" + request.status);
        	}
        }

       });
   	request.setRequestHeader("Pragma", "no-cache");
	request.setRequestHeader("Cache-Control", "no-cache");

    request.send("");

}

function readval_t()
{
    if (document.getElementById("iseditable").value == "0")
        aread();
    setTimeout(readval_t, 1000);

}


function check_real(str)
{
    let result = str.match(/^[+-]?\d+(\.\d+)?$/);

    return result != null;
}

function dbclickfield()
{
    set_editable(true);
}

function set_editable(val)
{
    if (val)
    {
        document.getElementById("write_sp").readOnly = "";
        document.getElementById("iseditable").value = "1";
        painterror();
    }
    else
    {
        document.getElementById("write_sp").readOnly = "readonly";
        document.getElementById("iseditable").value = "0";
        document.getElementById("write_sp").className = "monitor";
    }
}

function painterror()
{
    if (check_real(document.getElementById("write_sp").value))
        document.getElementById("write_sp").className = "edit";
    else
        document.getElementById("write_sp").className = "error";
}

function keypressfield(key)
{
    if (key == "Enter")
    {
        if (check_real(document.getElementById("write_sp").value))
        {
            awrite();
            set_editable(false);
        }
        else
        {
            alert("Неверный формат числа");
        }
    }
    else if(key == "Escape")
    {
        set_editable(false);
    }
    else
    {
        if (document.getElementById("iseditable").value == "1")
            painterror();
    }
}

function cmdon()
{
    var params = "?cmd"+document.getElementById("unitn").value+"=YOn";
	var request = new XMLHttpRequest();
    request.open('GET',document.location.origin+'/ahandler.htm'+params,true);
	request.setRequestHeader("Pragma", "no-cache");
	request.setRequestHeader("Cache-Control", "no-cache");
	request.send("");
}

function cmdoff()
{
    var params = "?cmd"+document.getElementById("unitn").value+"=YOff";
	var request = new XMLHttpRequest();
    request.open('GET',document.location.origin+'/ahandler.htm'+params,true);
	request.setRequestHeader("Pragma", "no-cache");
	request.setRequestHeader("Cache-Control", "no-cache");
	request.send("");
}

function awrite()
{
    print_console("Запрос инициирован...");
    
    var params = "?val"+document.getElementById("unitn").value+"=" + document.getElementById("write_sp").value;
    
	//alert(params);
	
    var request = new XMLHttpRequest();
    request.open('GET',document.location.origin+'/ahandler.htm'+params,true);
    request.addEventListener('readystatechange', function() {   	        
        
        if(request.readyState == 4)
        {
        	if(request.status==200)
        	{
	            print_console("Обмен завершен успешно.");
        	}
        	else
        	{
	            print_console("Ошибка:" + request.status);
        	}
        }

       });
   	request.setRequestHeader("Pragma", "no-cache");
	request.setRequestHeader("Cache-Control", "no-cache");

    request.send("");
}


function setunit(unit)
{
	document.getElementById("unitn").value=unit;
	
	document.getElementById("write_sp").value = "...";
	
	let i = 1;
	var uniti = parseInt(unit,10);
	while (i <= 12) 
	{ 
		if(i==uniti)
			document.getElementById("pv"+i).style.color = white;//.className = "selected";
		else
			document.getElementById("pv"+i).style.color = red;//.className = "monitor";
		i++;
	}
}

</script>

<style>
    .edit {
        background-color: white;
		//width:20%;
    }

    .monitor {
        background-color: #AAAAAA;
		//width:20%;
    }

    .error {
        background-color: #FF0000;
    }
	.selected
	{
		//background-color: #00FF00;
		border-color: red;
		//width:20%;
	}
	.button_is_on {
	  background-color: #4CAF50;
	  border: none;
	  color: white;
	  padding: 15px 32px;
	  text-align: center;
	  text-decoration: none;
	  display: inline-block;
	  font-size: 16px;
	  margin: 4px 2px;
	  cursor: pointer;
	}
	.button_is_off {
	  background-color: #000;
	  border: none;
	  color: white;
	  padding: 15px 32px;
	  text-align: center;
	  text-decoration: none;
	  display: inline-block;
	  font-size: 16px;
	  margin: 4px 2px;
	  cursor: pointer;
	}
</style>

</head>



<body onload="readval_t()">
<meta http-equiv="Cache-Control" content="no-cache">

<input id="status" value="status" style="width:500px">

<br/>

<!--<button id="ReadB" onclick="aread()">Read</button>-->
<!--<input id="readdt" readonly="readonly" value="....">-->

CKT 1-4:<br>
<input readOnly="readOnly" class="monitor" id="pv1" onclick="setunit(1)" value="">
<input readOnly="readOnly" class="monitor" id="pv2" onclick="setunit(2)" value="">
<input readOnly="readOnly" class="monitor" id="pv3" onclick="setunit(3)" value="">
<input readOnly="readOnly" class="monitor" id="pv4" onclick="setunit(4)" value="">
<br>
CKT 4-8:<br>
<input readOnly="readOnly" class="monitor" id="pv5" onclick="setunit(5)" value="">
<input readOnly="readOnly" class="monitor" id="pv6" onclick="setunit(6)" value="">
<input readOnly="readOnly" class="monitor" id="pv7" onclick="setunit(7)" value="">
<input readOnly="readOnly" class="monitor" id="pv8" onclick="setunit(8)" value="">
<br>
CKT 8-12:<br>
<input readOnly="readOnly" class="monitor" id="pv9" onclick="setunit(9)" value="">
<input readOnly="readOnly" class="monitor" id="pv10" onclick="setunit(10)" value="">
<input readOnly="readOnly" class="monitor" id="pv11" onclick="setunit(11)" value="">
<input readOnly="readOnly" class="monitor" id="pv12" onclick="setunit(12)" value="">
<br>
<br/>

<input id="write_sp" value="...." onclick="dbclickfield()" onkeyup="keypressfield(event.key)" class="monitor" readonly="readonly">
<br>
<button id="CmdOn" onclick="cmdon()">On</button>
<button id="CmdOff" onclick="cmdoff()">Off</button>


<input id="iseditable" type="hidden" value="0" />
<input id="unitn" type="hidden" value="1" />

</body>


</html>